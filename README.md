# SVG Layer Processor для Kiri:Moto

Скрипт для обработки SVG файлов, экспортированных из Kiri:Moto, с автоматической нумерацией слоёв и конвертацией в PDF формата A4.

## Возможности

1. **Нумерация слоёв** - добавляет видимые номера на каждый слой SVG
2. **Конвертация в PDF** - преобразует SVG в PDF с сохранением качества
3. **Разделение на A4** - автоматически делит длинный документ на стандартные страницы A4

## Требования

### Системные зависимости

Для работы `cairosvg` требуется:

**Linux (Ubuntu/Debian):**

```bash
sudo apt-get update
sudo apt-get install libcairo2-dev libpango1.0-dev
```

**macOS:**

```bash
brew install cairo pango
```

**Windows:**

- Скачайте GTK3: <https://github.com/tschoonj/GTK-for-Windows-Runtime-Environment-Installer/releases>
- Установите GTK3 Runtime

### Python библиотеки

```bash
pip install cairosvg PyPDF2 reportlab
```

## Использование

### Базовое использование

```bash
python process_svg_to_a4_pdf.py input.svg
```

Это создаст три файла в той же директории:

- `input_numbered.svg` - SVG с номерами на слоях
- `input_long.pdf` - PDF полной длины
- `input_A4.pdf` - PDF, разделённый на страницы A4 ✓ **ОСНОВНОЙ РЕЗУЛЬТАТ**

### Расширенное использование

```bash
# Указать директорию для результатов
python process_svg_to_a4_pdf.py input.svg --output ./results

# Изменить размер и цвет номеров
python process_svg_to_a4_pdf.py input.svg --font-size 4 --text-color blue

# Настроить позицию номеров
python process_svg_to_a4_pdf.py input.svg --offset-x 5 --offset-y -2
```

### Параметры командной строки

```
positional arguments:
  input                 Входной SVG файл

optional arguments:
  -h, --help            Показать справку
  --output, -o DIR      Директория для выходных файлов (по умолчанию: текущая)
  --font-size SIZE      Размер шрифта номеров в мм (по умолчанию: 3.0)
  --text-color COLOR    Цвет номеров (по умолчанию: red)
  --offset-x X          Смещение по X в мм (по умолчанию: 2.0)
  --offset-y Y          Смещение по Y в мм (по умолчанию: -1.0)
```

## Примеры

### Пример 1: Оригинальный файл из Kiri:Moto

```bash
python process_svg_to_a4_pdf.py ladyghoststl-2-014.svg
```

Результат:

- 525 слоёв пронумерованы
- Создан PDF на ~27 страниц A4

### Пример 2: Оптимизированный файл (nested)

```bash
python process_svg_to_a4_pdf.py nested2.svg --output ./nested_results
```

### Пример 3: Крупные синие номера

```bash
python process_svg_to_a4_pdf.py input.svg --font-size 5 --text-color blue --offset-x 3
```

## Как это работает

### Этап 1: Нумерация слоёв

- Скрипт находит все `<path>` элементы в SVG
- Для каждого слоя извлекает начальные координаты
- Добавляет текстовый элемент с номером рядом с началом пути
- Сохраняет модифицированный SVG

### Этап 2: Конвертация в PDF

- Использует `cairosvg` для высококачественной конвертации
- Создаёт PDF с теми же размерами, что и оригинальный SVG
- Сохраняет всю векторную графику

### Этап 3: Разделение на A4

- Вычисляет количество страниц A4 (высота / 297мм)
- Создаёт страницы A4, смещая содержимое по вертикали
- Обрезает каждую страницу до стандартного размера A4 (210×297мм)

## Структура файлов

```
project/
├── process_svg_to_a4_pdf.py    # Основной скрипт
├── README.md                    # Эта инструкция
└── input.svg                    # Ваш входной файл

После выполнения:
├── input_numbered.svg          # SVG с номерами
├── input_long.pdf              # Полный PDF
└── input_A4.pdf                # Готовый результат! ✓
```

## Часто задаваемые вопросы

### Q: Почему номера красные?

A: Красный цвет выбран для контраста с основным чёрным контуром. Можно изменить через `--text-color`.

### Q: Номера слишком маленькие/большие

A: Используйте `--font-size` для настройки размера (в миллиметрах).

### Q: Номера накладываются на контур

A: Настройте позицию через `--offset-x` и `--offset-y`.

### Q: Получается больше/меньше 31 страницы

A: Это зависит от высоты вашего SVG. Скрипт делит высоту на 297мм (высота A4).

### Q: Ошибка "cairo library not found"

A: Установите системные зависимости Cairo (см. раздел "Требования").

### Q: Как обработать оба файла (оригинальный и nested)?

A: Запустите скрипт дважды:

```bash
python process_svg_to_a4_pdf.py ladyghoststl-2-014.svg --output ./original
python process_svg_to_a4_pdf.py nested2.svg --output ./nested
```

## Технические детали

### Размеры

- **A4**: 210 × 297 мм
- **PDF points**: 1 мм = 2.834645669 points
- **A4 в points**: 595.276 × 841.890 points

### Формат слоёв Kiri:Moto

- Каждый слой представлен элементом `<path>`
- Слои имеют атрибут `z="0"` (не используется для нумерации)
- В оригинальных файлах слои имеют id (`path1`, `path2`, ...)
- В оптимизированных файлах id могут отсутствовать

### Нумерация

- Слои нумеруются по порядку появления в SVG: 1, 2, 3, ...
- Номер размещается у начальной точки каждого пути
- Используется начальная команда `m` или `M` из атрибута `d`

## Решение проблем

### Ошибка импорта cairosvg

```
ImportError: cannot import name 'cairosvg'
```

**Решение**: Установите системные зависимости Cairo и переустановите cairosvg:

```bash
# Linux
sudo apt-get install libcairo2-dev libpango1.0-dev
pip install --upgrade cairosvg

# macOS
brew install cairo pango
pip install --upgrade cairosvg
```

### Ошибка PyPDF2

```
ImportError: No module named 'PyPDF2'
```

**Решение**:

```bash
pip install PyPDF2
```

### Некорректное разделение страниц

Если страницы разделены неправильно, проверьте:

1. Размеры оригинального SVG (должны быть в мм)
2. Параметр `height` в SVG должен быть корректным

## Лицензия

MIT License - используйте свободно для личных и коммерческих проектов.

## Автор

Создано для обработки файлов из Kiri:Moto (веб-инструмент для 3D печати).

## Поддержка

При обнаружении проблем проверьте:

1. Версии библиотек: `pip list | grep -E "cairosvg|PyPDF2|reportlab"`
2. Корректность входного SVG файла
3. Права доступа к директориям

---

**Совет**: Для лучших результатов используйте SVG с разрешением 1мм, как в ваших файлах из Kiri:Moto.
