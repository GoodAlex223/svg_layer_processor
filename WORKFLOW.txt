# Схема работы скрипта

```
┌─────────────────────────────────────────────────────────────────────┐
│                    ВХОДНЫЕ ДАННЫЕ                                   │
├─────────────────────────────────────────────────────────────────────┤
│  • ladyghoststl-2-014.svg (оригинал из Kiri:Moto)                  │
│  • nested2.svg (оптимизированный через deepnest)                    │
│                                                                     │
│  Формат: 210mm (A4 ширина) × 7878mm (длина ~27 страниц A4)        │
│  Слоёв: 525                                                         │
└─────────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                 ШАГ 1: НУМЕРАЦИЯ СЛОЁВ                              │
├─────────────────────────────────────────────────────────────────────┤
│  Функция: add_layer_numbers_to_svg()                                │
│                                                                     │
│  Что происходит:                                                    │
│  1. Парсинг SVG → находит все <path> элементы                      │
│  2. Для каждого path:                                               │
│     • Извлекает начальные координаты (x, y)                        │
│     • Создаёт элемент <text> с номером                             │
│     • Размещает текст рядом с началом пути                         │
│  3. Сохраняет модифицированный SVG                                  │
│                                                                     │
│  Параметры:                                                         │
│  • font-size: 3mm (по умолчанию)                                   │
│  • text-color: red (по умолчанию)                                  │
│  • offset-x: +2mm, offset-y: -1mm                                  │
└─────────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  ПРОМЕЖУТОЧНЫЙ РЕЗУЛЬТАТ: *_numbered.svg                            │
│  ✓ SVG с видимыми номерами на каждом слое                          │
└─────────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                 ШАГ 2: КОНВЕРТАЦИЯ В PDF                            │
├─────────────────────────────────────────────────────────────────────┤
│  Функция: convert_svg_to_pdf()                                      │
│  Библиотека: cairosvg                                               │
│                                                                     │
│  Что происходит:                                                    │
│  1. Читает SVG с номерами                                           │
│  2. Рендерит в PDF с сохранением векторной графики                 │
│  3. Создаёт PDF размером 210mm × 7878mm (одна длинная страница)    │
│                                                                     │
│  Особенности:                                                       │
│  • Векторный формат (высокое качество)                             │
│  • Все номера слоёв включены                                        │
│  • Точное соответствие оригиналу                                    │
└─────────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  ПРОМЕЖУТОЧНЫЙ РЕЗУЛЬТАТ: *_long.pdf                                │
│  ✓ Полный PDF одной длинной страницей                              │
└─────────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                 ШАГ 3: РАЗДЕЛЕНИЕ НА A4                             │
├─────────────────────────────────────────────────────────────────────┤
│  Функция: split_pdf_to_a4_pages()                                   │
│  Библиотека: PyPDF2                                                 │
│                                                                     │
│  Что происходит:                                                    │
│  1. Читает длинный PDF                                              │
│  2. Вычисляет количество страниц: height / 297mm                   │
│     Для 7878mm: 7878 / 297 = ~26.5 → 27 страниц A4                │
│  3. Для каждой страницы:                                            │
│     • Создаёт новую страницу A4 (210×297mm)                        │
│     • Применяет вертикальное смещение                              │
│       - Страница 1: offset = 0mm                                   │
│       - Страница 2: offset = 297mm                                 │
│       - Страница 3: offset = 594mm                                 │
│       - ...                                                         │
│     • Обрезает до размеров A4                                       │
│  4. Объединяет все страницы в один PDF                             │
│                                                                     │
│  Формат A4:                                                         │
│  • 210 × 297 мм                                                     │
│  • 595.276 × 841.890 points (PDF единицы)                          │
└─────────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│             ФИНАЛЬНЫЙ РЕЗУЛЬТАТ: *_A4.pdf                           │
│  ✓✓✓ ГОТОВЫЙ PDF ДЛЯ ПЕЧАТИ ✓✓✓                                   │
│                                                                     │
│  • 27 страниц формата A4                                            │
│  • Каждый слой пронумерован (1-525)                                 │
│  • Готов для отправки на принтер                                    │
└─────────────────────────────────────────────────────────────────────┘
```

## Визуализация разделения на страницы

```
Оригинальный SVG (210mm × 7878mm):
┌──────────────────┐
│   Слой 1   (1)   │  ─┐
│   Слой 2   (2)   │   │
│   ...            │   │ Страница 1 A4
│   Слой 20  (20)  │   │ (0-297mm)
├──────────────────┤  ─┤
│   Слой 21  (21)  │   │
│   ...            │   │ Страница 2 A4
│   Слой 40  (40)  │   │ (297-594mm)
├──────────────────┤  ─┤
│   Слой 41  (41)  │   │
│   ...            │   │ Страница 3 A4
│   Слой 60  (60)  │   │ (594-891mm)
├──────────────────┤  ─┤
│   ...            │   
│   ...            │   │ ...ещё 24 страницы...
│   ...            │   
├──────────────────┤  ─┤
│   Слой 505 (505) │   │
│   ...            │   │ Страница 27 A4
│   Слой 525 (525) │   │ (7722-7878mm)
└──────────────────┘  ─┘
```

## Структура проекта после выполнения

```
your_project/
│
├── 📄 process_svg_to_a4_pdf.py    # Основной скрипт
├── 📄 requirements.txt             # Зависимости
├── 📄 README.md                    # Полная документация
├── 📄 QUICKSTART.md                # Краткое руководство
├── 📄 WORKFLOW.txt                 # Эта схема
│
├── 🔧 run_example.sh               # Запуск для Linux/macOS
├── 🔧 run_example.bat              # Запуск для Windows
│
├── 📂 Входные файлы:
│   ├── ladyghoststl-2-014.svg     # Ваш оригинал
│   └── nested2.svg                 # Оптимизированный
│
└── 📂 output_original/             # Результаты для оригинала
    ├── ladyghoststl-2-014_numbered.svg    # SVG с номерами
    ├── ladyghoststl-2-014_long.pdf        # PDF длинный
    └── ladyghoststl-2-014_A4.pdf          # 🎯 РЕЗУЛЬТАТ!
│
└── 📂 output_nested/               # Результаты для nested
    ├── nested2_numbered.svg        # SVG с номерами
    ├── nested2_long.pdf            # PDF длинный
    └── nested2_A4.pdf              # 🎯 РЕЗУЛЬТАТ!
```

## Технические детали

### Используемые библиотеки:

1. **xml.etree.ElementTree** (стандартная)
   - Парсинг и модификация XML/SVG
   - Добавление текстовых элементов

2. **cairosvg** (внешняя)
   - Рендеринг SVG в PDF
   - Поддержка векторной графики
   - Системные зависимости: libcairo2, libpango

3. **PyPDF2** (внешняя)
   - Чтение и запись PDF
   - Трансформации страниц
   - Разделение и объединение

4. **reportlab** (внешняя)
   - Константы размеров страниц
   - Конвертация мм → points

### Математика разделения:

```
Высота SVG:  7878 mm
Высота A4:    297 mm

Количество страниц = ⌈7878 / 297⌉ = ⌈26.525...⌉ = 27 страниц

Для страницы N (нумерация с 0):
  Y_offset = N × 297 mm
  Трансформация: translate(0, -Y_offset)
  Обрезка: [0, 0, 210mm, 297mm]
```

### Координатная система SVG:

```
(0, 0) ─────────────────────────────────→ X (210mm)
│
│  Слой 1 начинается с координаты (x₁, y₁)
│  Номер размещается в (x₁ + offset_x, y₁ + offset_y)
│
│  По умолчанию: offset_x = +2mm, offset_y = -1mm
│  Это размещает номер справа и чуть выше начала пути
│
↓
Y (7878mm)
```

---

**Примечание:** Эта схема описывает логику работы скрипта для понимания внутренних процессов.
